<!DOCTYPE html>
<html>
<head>
  <title>Configit Model - Web modeller</title>
  <link rel="stylesheet" type="text/css" href="./resources/ui.css" />
  <link rel="stylesheet" type="text/css" href="./resources/ui-common.css" />
  <link rel="stylesheet" type="text/css" href="./resources/ui-default.css" />
  <script type="text/javascript" src="./build/waspioc.js"></script>
  <script type="text/javascript">
    window.addEventListener('load', function() {
      var ioc = waspioc.core.ioc,
          util = waspioc.core.util,
          context = ioc.ServiceContext.getCurrentContext();

      function UT_CreateAndDisposeContext() {
        /* injected properties*/
        this.logger = '';
        this.context = '';

        this.afterPropertiesSet = function() {
          this.logger.log('Checking if logger was registered');
          util.ParamChecker.assertNotNull(this.logger, 'logger');
          this.logger.log('Checking if context was registered');
          util.ParamChecker.assertNotNull(this.context, 'context');
          this.logger.log('Checking if context is also the main context');
          util.ParamChecker.assert(this.context === ioc.ServiceContext.getCurrentContext(), 'The context must be set');
          util.ParamChecker.assert(this.context.getCurrentState() === ioc.ServiceContextState.STARTING, 'Expected context to be in STARTING state');
        };

        this.afterStarted = function() {
          util.ParamChecker.assert(this.context.getCurrentState() === ioc.ServiceContextState.RUNNING, 'Expected context to be in RUNNING state');
          var self = this;
          setTimeout(function() {
            self.logger.log('Disposing');
            self.context.dispose();
          }, 1000);
        };

        this.afterStopped = function() {
          util.ParamChecker.assert(this.context.getCurrentState() === ioc.ServiceContextState.DISPOSED, 'Expected context to be in RUNNING state');
          this.logger.log('Dispose completed');
          var self = this;
          this.logger.log('Asserting that context cannot be disposed twice');
          util.ParamChecker.assertError(function() {
            self.context.dispose();
          }, 'Disposing context second time should have thrown an error!');
        };
      }

      function TM_Context() {
        this.getBeanTypes = function() {
          return [ioc.BeanType.MODULE];
        };

        this.initializeContext = function(context) {
          util.ParamChecker.assert(context.getCurrentState() === ioc.ServiceContextState.INIT, 'Expected context to be in INIT state');

          UT_CreateAndDisposeContext.prototype.getBeanTypes = function() {
            return [ioc.BeanType.INITIALIZING, ioc.BeanType.STARTING, ioc.BeanType.DISPOSING];
          };

          context.register('ContextChecker', UT_CreateAndDisposeContext);

          context.registerProperty('logger', console);
          context.registerProperty('context', context);
        }
      }

      function TestModule() {
        this.getBeanTypes = function() {
          return [waspioc.core.ioc.BeanType.MODULE];
        };

        this.initializeContext = function(context) {
          function UT_ContextInitiated() {
            this.logger = '';
            this.serviceContext = '';

            this.afterStarted = function() {
              // get the viewmodel
              var bean = this.serviceContext.getItem('viewModel');
              var match = this.serviceContext.getItem('singleItem') === bean.item.complex;
              this.logger.log('instance bean matches bean property? ' + (match ? "yes" : "no") );
              bean.newValue = 'yeehaw';
              var bean2 = this.serviceContext.getItem('viewModel');
              this.logger.log('same bean names = same instance? ' + (bean === bean2 ? "yes": "no") );
            };
          }

          function ViewModel() {
            this.viewBag = 4;

            this.afterPropertiesSet = function() {
              this.viewBag = 8;
            };
          }

          /* register bean interfaces */
          UT_ContextInitiated.prototype.getBeanTypes = function() {
            return [waspioc.core.ioc.BeanType.STARTING];
          };

          ViewModel.prototype.getBeanTypes = function() {
            return [waspioc.core.ioc.BeanType.INITIALIZING];
          };

          /* unit test setup */
          var item = {
            test: 'A',
            prop: 5
          };

          // register unit test (should be the same if it's first or last)
          context.register('unit_test_context', UT_ContextInitiated);
          // register context
          context.registerInstance('singleItem', item);
          context.register('item', item.constructor).value('test', 'A').reference('complex', 'singleItem');
          context.register('viewModel', ViewModel).reference('item', 'item');

          context.registerProperty('logger', console);
          context.registerProperty('serviceContext', context);
        }
      }

      context.registerModule('testContextModule', new TM_Context());
      context.registerModule('screenModule', new TestModule());
      // start the context
      context.start();
    });
  </script>
</head>
<body>
</body>
</html>
